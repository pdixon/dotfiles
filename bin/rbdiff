#!/bin/bash

# we use a temp to catch the output in the first instance
TMP_FILE=$(mktemp /tmp/temp.XXXX)

# exclude up front the bin files we know about
BIN_FILES='{doc,wpr,odt,png,jpg,exe,xls}'
DIFF_OPTS="--reverse --ignore-all-space --exclude \"glob:**.${BIN_FILES}\" -rtip -rtip"

# our project repo
REPO="ssh://wh/ichair"

# tip to tip diff - not working dir!
DIFF_CMD="hg diff $DIFF_OPTS $REPO" 

# Now, we have excluded already the binary files for which we know the extension,
# but there still may be some others such the 'qspy' linux exe. We will use the
# filter expression below to remove these lines from the patch as otherwise they
# will bugger up reviewboard. 
FILTER_CMD="diff-clean"

# we may need to remove our temp files
function on_exit()
{
    if [[ $? == 0 ]]
    then
        echo All good: ${PATCH_FILE} created
    else
        echo "Abort: last command returned $?"
    fi

    if [ -e $TMP_FILE ]
    then
        rm $TMP_FILE
    fi
}
trap "on_exit" INT TERM EXIT

# do the diff and save the results
if eval ${DIFF_CMD} > $TMP_FILE
then
    # then from the top of the results pluck out the changeset ids to use as a filename
    PATCH_FILE=$(grep "^diff" $TMP_FILE|head -n1|awk '{printf("patch-%s-%s",$3,$5)}')

    if [ -n $PATCH_FILE ]
    then
        # now filter out extraneous binary files and save the output
        cat $TMP_FILE | $FILTER_CMD > $PATCH_FILE
    else
        false
    fi
fi


